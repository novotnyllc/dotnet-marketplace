name: Release

on:
  push:
    tags:
      - 'dotnet-artisan/v*'

permissions:
  contents: write

jobs:
  release:
    name: Validate and release
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          # Tag format: dotnet-artisan/v0.1.0 -> version: 0.1.0
          VERSION="${TAG#dotnet-artisan/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Validate root marketplace.json
        run: |
          set -euo pipefail
          jq empty .claude-plugin/marketplace.json

          PLUGIN_COUNT=$(jq '.plugins | length' .claude-plugin/marketplace.json)
          for i in $(seq 0 $(( PLUGIN_COUNT - 1 ))); do
            SOURCE=$(jq -r ".plugins[$i].source" .claude-plugin/marketplace.json)
            if [ ! -d "$SOURCE" ] || [ ! -f "$SOURCE/.claude-plugin/plugin.json" ]; then
              echo "FAIL: plugin source '$SOURCE' invalid"
              exit 1
            fi
          done
          echo "OK: root marketplace.json"

      - name: Validate plugin structure
        run: |
          set -o pipefail
          cd plugins/dotnet-artisan
          ./scripts/validate-skills.sh | tee /tmp/skills-output.txt

      - name: Validate marketplace
        run: |
          cd plugins/dotnet-artisan
          ./scripts/validate-marketplace.sh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: dotnet-artisan v${{ steps.version.outputs.version }}
          body: |
            ## dotnet-artisan v${{ steps.version.outputs.version }}

            .NET development skills plugin for Claude Code.

            ### Install

            ```
            /plugin marketplace add novotnyllc/dotnet-marketplace
            /plugin install dotnet-artisan
            ```

            ### Validation
            All validation checks passed before release:
            - Root marketplace.json validation
            - Plugin structure and skill validation
            - Marketplace metadata validation
