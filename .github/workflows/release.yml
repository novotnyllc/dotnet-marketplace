name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write
  id-token: write

# Only allow one Pages deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  validate-and-deploy:
    name: Validate, release, and deploy to Pages
    runs-on: ubuntu-latest
    timeout-minutes: 5

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          # Strip leading 'v' for semver
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Validate plugin structure
        run: |
          set -o pipefail
          ./scripts/validate-skills.sh | tee /tmp/skills-output.txt

      - name: Validate marketplace
        run: ./scripts/validate-marketplace.sh

      - name: Generate dist/ outputs
        run: |
          set -o pipefail
          python3 scripts/generate_dist.py --strict 2>&1 | tee /tmp/generate-output.txt

      - name: Validate cross-agent conformance
        run: |
          set -o pipefail
          python3 scripts/validate_cross_agent.py 2>&1 | tee /tmp/conformance-output.txt

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body: |
            ## dotnet-artisan ${{ steps.version.outputs.tag }}

            Cross-agent distribution for .NET development skills.

            ### Distribution

            Deployed to GitHub Pages:
            - **Manifest**: `https://<user>.github.io/<repo>/manifest.json`
            - **Claude**: `https://<user>.github.io/<repo>/claude/`
            - **Copilot**: `https://<user>.github.io/<repo>/copilot/`
            - **Codex**: `https://<user>.github.io/<repo>/codex/`

            ### Validation
            All validation checks passed before deployment:
            - Plugin structure and skill validation
            - Marketplace metadata validation
            - Cross-agent generation (--strict mode)
            - Cross-agent conformance (7 checks including manifest validation)
