name: Validate Plugin

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: validate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Job 1: Structural lint (no .NET needed, runs in parallel with build-test) ──
  lint:
    name: Lint & validate structure
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      STRICT_REFS: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate plugin JSON files
        run: |
          set -euo pipefail
          echo "=== Plugin JSON Validation ==="
          jq empty .claude-plugin/plugin.json
          echo "OK: plugin.json"
          jq empty hooks/hooks.json
          echo "OK: hooks.json"
          jq empty .mcp.json
          echo "OK: .mcp.json"

      - name: Validate root marketplace.json
        run: |
          set -o pipefail
          ./scripts/validate-root-marketplace.sh | tee /tmp/root-marketplace-output.txt

      - name: Validate skills
        id: validate-skills
        run: |
          set -o pipefail
          VALIDATE_EXIT=0
          ./scripts/validate-skills.sh | tee /tmp/skills-output.txt || VALIDATE_EXIT=$?

          # Parse stable output keys for summary (validator)
          CURRENT=$(grep '^CURRENT_DESC_CHARS=' /tmp/skills-output.txt | cut -d= -f2 || echo "")
          PROJECTED=$(grep '^PROJECTED_DESC_CHARS=' /tmp/skills-output.txt | cut -d= -f2 || echo "")
          STATUS=$(grep '^BUDGET_STATUS=' /tmp/skills-output.txt | cut -d= -f2 || echo "")
          MISSING_SCOPE=$(grep '^MISSING_SCOPE_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "")
          MISSING_OOS=$(grep '^MISSING_OOS_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "")
          SELF_REF=$(grep '^SELF_REF_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "")
          AGENT_BARE=$(grep '^AGENT_BARE_REF_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "")
          AGENTSMD_BARE=$(grep '^AGENTSMD_BARE_REF_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "")

          echo "current_desc_chars=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "projected_desc_chars=$PROJECTED" >> "$GITHUB_OUTPUT"
          echo "budget_status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "missing_scope_count=$MISSING_SCOPE" >> "$GITHUB_OUTPUT"
          echo "missing_oos_count=$MISSING_OOS" >> "$GITHUB_OUTPUT"
          echo "self_ref_count=$SELF_REF" >> "$GITHUB_OUTPUT"
          echo "agent_bare_ref_count=$AGENT_BARE" >> "$GITHUB_OUTPUT"
          echo "agentsmd_bare_ref_count=$AGENTSMD_BARE" >> "$GITHUB_OUTPUT"

          # Parse stable output keys for summary (similarity, if present)
          MAX_SIM=$(grep '^MAX_SIMILARITY_SCORE=' /tmp/skills-output.txt | cut -d= -f2 || echo "N/A")
          PAIRS_WARN=$(grep '^PAIRS_ABOVE_WARN=' /tmp/skills-output.txt | cut -d= -f2 || echo "N/A")
          PAIRS_ERROR=$(grep '^PAIRS_ABOVE_ERROR=' /tmp/skills-output.txt | cut -d= -f2 || echo "N/A")

          echo "max_similarity_score=$MAX_SIM" >> "$GITHUB_OUTPUT"
          echo "pairs_above_warn=$PAIRS_WARN" >> "$GITHUB_OUTPUT"
          echo "pairs_above_error=$PAIRS_ERROR" >> "$GITHUB_OUTPUT"

          exit "$VALIDATE_EXIT"

      - name: Enforce routing quality gates
        run: |
          set -euo pipefail
          echo "=== Routing Quality Gates ==="

          # Gate 1: Agent bare references must be zero (tightened from informational)
          AGENT_BARE=$(grep '^AGENT_BARE_REF_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "0")
          AGENTSMD_BARE=$(grep '^AGENTSMD_BARE_REF_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "0")
          GATE_FAIL=0

          if [ "$AGENT_BARE" -gt 0 ] 2>/dev/null; then
            echo "FAIL: AGENT_BARE_REF_COUNT=$AGENT_BARE (must be 0)"
            GATE_FAIL=1
          else
            echo "OK: AGENT_BARE_REF_COUNT=$AGENT_BARE"
          fi

          if [ "$AGENTSMD_BARE" -gt 0 ] 2>/dev/null; then
            echo "FAIL: AGENTSMD_BARE_REF_COUNT=$AGENTSMD_BARE (must be 0)"
            GATE_FAIL=1
          else
            echo "OK: AGENTSMD_BARE_REF_COUNT=$AGENTSMD_BARE"
          fi

          # Gate 2: Self-references must be zero
          SELF_REF=$(grep '^SELF_REF_COUNT=' /tmp/skills-output.txt | cut -d= -f2 || echo "0")
          if [ "$SELF_REF" -gt 0 ] 2>/dev/null; then
            echo "FAIL: SELF_REF_COUNT=$SELF_REF (must be 0)"
            GATE_FAIL=1
          else
            echo "OK: SELF_REF_COUNT=$SELF_REF"
          fi

          # Gate 3: Per-key baseline regression check
          BASELINE_FILE="scripts/routing-warnings-baseline.json"
          if [ -f "$BASELINE_FILE" ]; then
            echo ""
            echo "--- Per-Key Baseline Regression Check ---"
            REGRESSION=0
            for KEY in NAME_DIR_MISMATCHES EXTRA_FIELD_COUNT TYPE_WARNING_COUNT FILLER_PHRASE_COUNT WHEN_PREFIX_COUNT MISSING_SCOPE_COUNT MISSING_OOS_COUNT SELF_REF_COUNT AGENT_BARE_REF_COUNT AGENTSMD_BARE_REF_COUNT; do
              BASELINE_VAL=$(jq -r ".keys.${KEY} // empty" "$BASELINE_FILE" 2>/dev/null || echo "")
              CURRENT_VAL=$(grep "^${KEY}=" /tmp/skills-output.txt | cut -d= -f2 || echo "")

              if [ -z "$BASELINE_VAL" ]; then
                echo "FAIL: $KEY missing from baseline ($BASELINE_FILE)"
                REGRESSION=1
                continue
              fi

              if [ -z "$CURRENT_VAL" ]; then
                echo "FAIL: $KEY missing from validator output (/tmp/skills-output.txt)"
                REGRESSION=1
                continue
              fi

              if ! [[ "$BASELINE_VAL" =~ ^[0-9]+$ && "$CURRENT_VAL" =~ ^[0-9]+$ ]]; then
                echo "FAIL: $KEY non-numeric (baseline=$BASELINE_VAL, current=$CURRENT_VAL)"
                REGRESSION=1
                continue
              fi

              if [ "$CURRENT_VAL" -gt "$BASELINE_VAL" ] 2>/dev/null; then
                echo "FAIL: $KEY regressed ($BASELINE_VAL -> $CURRENT_VAL)"
                REGRESSION=1
              else
                echo "OK: $KEY ($CURRENT_VAL <= $BASELINE_VAL)"
              fi
            done

            if [ "$REGRESSION" -eq 1 ]; then
              echo ""
              echo "Baseline regression detected. Fix the issues or update scripts/routing-warnings-baseline.json."
              GATE_FAIL=1
            fi
          else
            echo "FAIL: Baseline file $BASELINE_FILE not found (required for regression gating)"
            GATE_FAIL=1
          fi

          if [ "$GATE_FAIL" -eq 1 ]; then
            exit 1
          fi

          echo ""
          echo "All routing quality gates passed."

      - name: Validate marketplace
        run: ./scripts/validate-marketplace.sh

      - name: Validate version consistency
        run: |
          set -euo pipefail
          echo "=== Version Consistency Check ==="

          # Read version from plugin.json (canonical source of truth)
          PLUGIN_VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
          echo "plugin.json version: $PLUGIN_VERSION"

          # Read version from root marketplace.json plugin entry
          MARKETPLACE_PLUGIN_VERSION=$(jq -r '.plugins[] | select(.name == "dotnet-artisan") | .version' .claude-plugin/marketplace.json)
          echo "root marketplace.json plugin version: $MARKETPLACE_PLUGIN_VERSION"

          # Read version from root marketplace.json metadata
          MARKETPLACE_META_VERSION=$(jq -r '.metadata.version' .claude-plugin/marketplace.json)
          echo "root marketplace.json metadata.version: $MARKETPLACE_META_VERSION"

          # Compare all three
          FAIL=0
          if [ "$PLUGIN_VERSION" != "$MARKETPLACE_PLUGIN_VERSION" ]; then
            echo "FAIL: plugin.json version ($PLUGIN_VERSION) != root marketplace plugin version ($MARKETPLACE_PLUGIN_VERSION)"
            FAIL=1
          fi
          if [ "$PLUGIN_VERSION" != "$MARKETPLACE_META_VERSION" ]; then
            echo "FAIL: plugin.json version ($PLUGIN_VERSION) != root marketplace metadata.version ($MARKETPLACE_META_VERSION)"
            FAIL=1
          fi

          if [ "$FAIL" -eq 1 ]; then
            echo ""
            echo "Version mismatch detected. Run ./scripts/bump.sh to update all version locations."
            exit 1
          fi

          echo "OK: All version locations are consistent ($PLUGIN_VERSION)"

      - name: Assert skill count
        run: |
          set -euo pipefail
          echo "=== Skill Count Assertion ==="
          EXPECTED=131
          ACTUAL=$(find skills -name SKILL.md -maxdepth 2 | wc -l | tr -d ' ')
          echo "Expected: $EXPECTED"
          echo "Actual:   $ACTUAL"
          if [ "$ACTUAL" -ne "$EXPECTED" ]; then
            echo "FAIL: Skill count mismatch (expected $EXPECTED, found $ACTUAL)"
            exit 1
          fi
          echo "OK: Skill count matches ($ACTUAL)"

      - name: Write job summary
        if: always()
        run: |
          echo "## Plugin Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Description Budget" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Current description chars | ${{ steps.validate-skills.outputs.current_desc_chars }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Projected description chars | ${{ steps.validate-skills.outputs.projected_desc_chars }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Budget status | ${{ steps.validate-skills.outputs.budget_status }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Routing Quality" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value | Gate |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Missing scope sections | ${{ steps.validate-skills.outputs.missing_scope_count }} | baseline |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Missing out-of-scope sections | ${{ steps.validate-skills.outputs.missing_oos_count }} | baseline |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Self-referential cross-links | ${{ steps.validate-skills.outputs.self_ref_count }} | == 0 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Agent bare references | ${{ steps.validate-skills.outputs.agent_bare_ref_count }} | == 0 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| AGENTS.md bare references | ${{ steps.validate-skills.outputs.agentsmd_bare_ref_count }} | == 0 |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Semantic Similarity" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value | Gate |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Max similarity score | ${{ steps.validate-skills.outputs.max_similarity_score }} | informational |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Pairs above WARN (>= 0.55) | ${{ steps.validate-skills.outputs.pairs_above_warn }} | baseline + suppressions |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Pairs above ERROR (>= 0.75) | ${{ steps.validate-skills.outputs.pairs_above_error }} | == 0 (unsuppressed) |" >> "$GITHUB_STEP_SUMMARY"

  # ── Job 2: .NET routing runner (runs in parallel with lint) ──
  build-test:
    name: Build & test routing runner
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.local/share/NuGet/v3-cache
          key: nuget-${{ runner.os }}-${{ hashFiles('tests/agent-routing/check-skills.cs') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore tests/agent-routing/check-skills.cs

      - name: Build
        run: dotnet build tests/agent-routing/check-skills.cs -c Release --no-restore

      - name: Self-test
        run: dotnet run --file tests/agent-routing/check-skills.cs -- --self-test

  # ── Job 3: Copilot smoke (depends on both lint + build-test) ──
  copilot-smoke:
    name: Copilot smoke tests
    needs: [lint, build-test]
    # Only run on pull_request events (push to main has no fork context)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Detect fork
        id: detect-env
        run: |
          set -euo pipefail
          IS_FORK="${{ github.event.pull_request.head.repo.fork }}"
          echo "is_fork=$IS_FORK" >> "$GITHUB_OUTPUT"

      - name: Install Copilot CLI (non-fork only)
        id: install-copilot
        if: steps.detect-env.outputs.is_fork != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || github.token }}
        run: |
          set -euo pipefail
          echo "=== Installing Copilot CLI ==="
          npm view @github/copilot version >/dev/null
          npm install -g @github/copilot

          COPILOT_VERSION="$(copilot --version 2>/dev/null | head -n 1 || true)"
          if [ -z "$COPILOT_VERSION" ]; then
            COPILOT_VERSION='unknown'
          fi
          echo "Copilot CLI version: $COPILOT_VERSION"
          echo "copilot_version=$COPILOT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Health check (copilot --version)
        id: health-check
        if: steps.detect-env.outputs.is_fork != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || github.token }}
        run: |
          set -euo pipefail
          copilot --version

      - name: Register plugin (non-fork only)
        id: register-plugin
        if: steps.detect-env.outputs.is_fork != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || github.token }}
        run: |
          set -euo pipefail
          REPO_ROOT="$(pwd)"

          # Use same mechanism as test.sh:prepare_copilot_plugin()
          copilot plugin marketplace add "$REPO_ROOT"
          if ! copilot plugin install dotnet-artisan@dotnet-artisan 2>/dev/null; then
            copilot plugin update dotnet-artisan@dotnet-artisan
          fi

          # Verify discovery (tighten grep to local source)
          if ! copilot plugin marketplace list | grep -F "dotnet-artisan" | grep -qF "$REPO_ROOT"; then
            echo "ERROR: dotnet-artisan not pointing at $REPO_ROOT in marketplace list"
            copilot plugin marketplace list
            exit 1
          fi
          echo "OK: dotnet-artisan registered from $REPO_ROOT"

      - name: Run Copilot smoke tests
        id: smoke-run
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || github.token }}
        run: |
          set -uo pipefail

          SMOKE_ARGS=()
          # Deterministic smoke subset (8 cases, spec: 5-10):
          #   3 direct activation, 1 advisor-routed (smoke-011, non-flaky),
          #   2 negative controls, 2 direct (different domains)
          # Per fn-57.4: "direct activation, advisor routing, and one negative control"
          SMOKE_ARGS+=(--case-id "smoke-001,smoke-003,smoke-004,smoke-011,smoke-016,smoke-017,smoke-026,smoke-027")
          SMOKE_ARGS+=(--timeout-seconds 120)
          SMOKE_ARGS+=(--output "tests/copilot-smoke/ci-results.json")

          IS_FORK="${{ steps.detect-env.outputs.is_fork }}"

          if [ "$IS_FORK" = "true" ]; then
            echo "::notice::Copilot skipped (fork PR, no access to secrets)"

            # Produce synthetic infra_error results for observability
            python tests/copilot-smoke/run_smoke.py \
              "${SMOKE_ARGS[@]}" || true

            echo "smoke_status=skipped" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Non-fork: Copilot is required -- infra_error causes failure
          SMOKE_ARGS+=(--require-copilot)

          set +e
          python tests/copilot-smoke/run_smoke.py "${SMOKE_ARGS[@]}"
          SMOKE_EXIT=$?
          set -e

          if [ "$SMOKE_EXIT" -eq 0 ]; then
            echo "smoke_status=passed" >> "$GITHUB_OUTPUT"
          elif [ "$SMOKE_EXIT" -eq 1 ]; then
            echo "::warning::Copilot smoke functional mismatches detected (non-blocking); see uploaded artifact."
            echo "smoke_status=soft_failed" >> "$GITHUB_OUTPUT"
          elif [ "$SMOKE_EXIT" -eq 2 ]; then
            echo "smoke_status=infra_error" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "smoke_status=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Upload smoke results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: copilot-smoke-results
          path: |
            tests/copilot-smoke/ci-results.json
            tests/copilot-smoke/results-agent-routing-compat.json
          if-no-files-found: warn

      - name: Write smoke summary
        if: always()
        run: |
          echo "## Copilot Smoke Tests" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Setting | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Fork PR | ${{ steps.detect-env.outputs.is_fork }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Copilot installed | ${{ steps.install-copilot.outcome || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Health check | ${{ steps.health-check.outcome || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Plugin registered | ${{ steps.register-plugin.outcome || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Smoke status | ${{ steps.smoke-run.outputs.smoke_status || 'unknown' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Copilot version | ${{ steps.install-copilot.outputs.copilot_version || 'N/A' }} |" >> "$GITHUB_STEP_SUMMARY"
