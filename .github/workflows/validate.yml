name: Validate Plugin

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  validate:
    name: Validate plugin structure and skills
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate root marketplace.json
        run: |
          set -euo pipefail
          echo "=== Root Marketplace Validation ==="
          jq empty .claude-plugin/marketplace.json
          echo "OK: marketplace.json is valid JSON"

          # Verify each plugin source path resolves to a directory with plugin.json
          PLUGIN_COUNT=$(jq '.plugins | length' .claude-plugin/marketplace.json)
          echo "Found $PLUGIN_COUNT plugin(s) in marketplace"

          for i in $(seq 0 $(( PLUGIN_COUNT - 1 ))); do
            SOURCE=$(jq -r ".plugins[$i].source" .claude-plugin/marketplace.json)
            NAME=$(jq -r ".plugins[$i].name" .claude-plugin/marketplace.json)
            if [ ! -d "$SOURCE" ]; then
              echo "FAIL: plugin '$NAME' source path '$SOURCE' is not a directory"
              exit 1
            fi
            if [ ! -f "$SOURCE/.claude-plugin/plugin.json" ]; then
              echo "FAIL: plugin '$NAME' missing .claude-plugin/plugin.json at '$SOURCE'"
              exit 1
            fi
            echo "OK: plugin '$NAME' source '$SOURCE' resolves with plugin.json"
          done

      - name: Validate plugin JSON files
        run: |
          echo "=== Plugin JSON Validation ==="
          jq empty plugins/dotnet-artisan/.claude-plugin/plugin.json
          echo "OK: plugin.json"
          jq empty plugins/dotnet-artisan/.claude-plugin/marketplace.json
          echo "OK: marketplace.json"
          jq empty plugins/dotnet-artisan/hooks/hooks.json
          echo "OK: hooks.json"
          jq empty plugins/dotnet-artisan/.mcp.json
          echo "OK: .mcp.json"

      - name: Validate skills
        id: validate-skills
        run: |
          set -o pipefail
          cd plugins/dotnet-artisan
          ./scripts/validate-skills.sh | tee /tmp/skills-output.txt

          # Parse stable output keys for summary
          CURRENT=$(grep '^CURRENT_DESC_CHARS=' /tmp/skills-output.txt | cut -d= -f2)
          PROJECTED=$(grep '^PROJECTED_DESC_CHARS=' /tmp/skills-output.txt | cut -d= -f2)
          STATUS=$(grep '^BUDGET_STATUS=' /tmp/skills-output.txt | cut -d= -f2)

          echo "current_desc_chars=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "projected_desc_chars=$PROJECTED" >> "$GITHUB_OUTPUT"
          echo "budget_status=$STATUS" >> "$GITHUB_OUTPUT"

      - name: Validate marketplace
        run: |
          cd plugins/dotnet-artisan
          ./scripts/validate-marketplace.sh

      - name: Write job summary
        if: always()
        run: |
          echo "## Plugin Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Current description chars | ${{ steps.validate-skills.outputs.current_desc_chars }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Projected description chars | ${{ steps.validate-skills.outputs.projected_desc_chars }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Budget status | ${{ steps.validate-skills.outputs.budget_status }} |" >> "$GITHUB_STEP_SUMMARY"
