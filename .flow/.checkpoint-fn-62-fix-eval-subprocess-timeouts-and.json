{
  "created_at": "2026-02-25T06:49:10.150494Z",
  "epic": {
    "data": {
      "branch_name": "fn-62-fix-eval-subprocess-timeouts-and",
      "completion_review_status": "unknown",
      "completion_reviewed_at": null,
      "created_at": "2026-02-25T06:47:32.137625Z",
      "default_impl": null,
      "default_review": null,
      "default_sync": null,
      "depends_on_epics": [],
      "id": "fn-62-fix-eval-subprocess-timeouts-and",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-62-fix-eval-subprocess-timeouts-and.md",
      "status": "open",
      "title": "Fix eval subprocess timeouts and process cleanup",
      "updated_at": "2026-02-25T06:47:55.757993Z"
    },
    "spec": "# Fix eval subprocess timeouts and process cleanup\n\n## Overview\n\nEval tests hang indefinitely because `subprocess.run(timeout=120)` kills only the direct child PID \u2014 not the process group. The `claude` CLI is a Node.js app that spawns child processes; those orphans survive SIGKILL and keep pipes open. Combined with missing `--max-turns 1`, no per-runner wall-clock cap, and hardcoded timeouts, a single hanging case can block for 8+ minutes (4 attempts \u00d7 120s) before the consecutive-failure tracker kicks in.\n\n## Scope\n\n- Fix process tree cleanup in `_execute_cli()` using `Popen` + `process_group=0` + `os.killpg()`\n- Add `--max-turns 1` to `_build_cli_command()` for bounded single-turn classification\n- Add protective env vars (`DISABLE_TELEMETRY`, `DISABLE_ERROR_REPORTING`) to `_subprocess_env()`\n- Make timeouts configurable in `config.yaml` with per-eval-type overrides\n- Add per-runner wall-clock timeout in `run_suite.sh` with macOS shim\n- Reduce default per-case timeout from 120s to 45s (activation/confusion) with higher defaults for effectiveness/size_impact\n\n## Out of scope\n\n- Agent SDK migration (replaces subprocess management entirely \u2014 separate effort)\n- Eval case content changes (handled by fn-60)\n- CI pipeline integration (handled by fn-58)\n\n## Quick commands\n\n```bash\n# Run activation eval with --limit to test timeout behavior\npython3 tests/evals/run_activation.py --limit 3\n\n# Full suite with bounded execution\n./tests/evals/run_suite.sh --runs 1 --limit 5\n```\n\n## Acceptance\n\n- [ ] No single eval case takes more than 60s total (including retries)\n- [ ] No orphaned `claude`/`node` processes after a timed-out case\n- [ ] `config.yaml` has a `timeouts` section with per-type values\n- [ ] `run_suite.sh` has per-runner wall-clock timeout (works on both Linux and macOS)\n- [ ] All existing eval tests still pass with the new timeout values\n\n## References\n\n- `tests/evals/_common.py` \u2014 `_execute_cli()` L573-663, `_build_cli_command()` L504-544, `_subprocess_env()` L196-215\n- `tests/evals/run_suite.sh` \u2014 `run_runner()` L150-194\n- `tests/evals/config.yaml` \u2014 no `timeouts` section currently\n- CPython: `subprocess.run` timeout calls `os.kill(pid, SIGKILL)` \u2014 does NOT call `os.killpg()` even with `process_group=0`\n- anthropics/claude-code#26009, #26224 \u2014 known CLI hanging issues\n- cc-plugin-eval: two-tier timeout pattern (interrupt_first + hard abort)\n- MLflow: uses `--max-turns 1` + `timeout=30` for probes\n"
  },
  "epic_id": "fn-62-fix-eval-subprocess-timeouts-and",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-25T06:48:00.550357Z",
        "depends_on": [],
        "epic": "fn-62-fix-eval-subprocess-timeouts-and",
        "id": "fn-62-fix-eval-subprocess-timeouts-and.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-62-fix-eval-subprocess-timeouts-and.1.md",
        "status": "todo",
        "title": "Fix _execute_cli process group kill and add --max-turns + configurable timeouts",
        "updated_at": "2026-02-25T06:48:28.401846Z"
      },
      "id": "fn-62-fix-eval-subprocess-timeouts-and.1",
      "runtime": null,
      "spec": "# fn-62-fix-eval-subprocess-timeouts-and.1 Fix _execute_cli process group kill and add --max-turns + configurable timeouts\n\n## Description\nRefactor `_execute_cli()` in `_common.py` to use `subprocess.Popen` with `process_group=0` instead of `subprocess.run`, so the entire process tree (claude + Node.js children) is killed on timeout via `os.killpg()`. Add `--max-turns 1` to `_build_cli_command()` for single-turn classification evals. Make timeouts configurable via `config.yaml` with per-eval-type overrides. Add protective env vars to `_subprocess_env()`.\n\n**Size:** M\n**Files:** `tests/evals/_common.py`, `tests/evals/config.yaml`\n\n## Approach\n\n- Replace `subprocess.run()` at L573-663 with `Popen` + `communicate(timeout=N)` + `os.killpg()` in `TimeoutExpired` handler\n- Two-phase kill: SIGTERM \u2192 3s grace \u2192 SIGKILL (follow pattern from cc-plugin-eval and python-chess)\n- After `killpg`, call `proc.communicate(timeout=5)` to drain pipes and prevent zombies\n- Add `--max-turns`, `1` to the CLI args list in `_build_cli_command()` at L504-544 \u2014 verify the flag exists by checking `claude -p --help` first; if absent, skip this change and document in the PR\n- Add `timeouts` section to `config.yaml`:\n  ```yaml\n  timeouts:\n    activation: 45\n    confusion: 45\n    effectiveness: 90\n    size_impact: 90\n    probe: 15\n    kill_grace: 3\n  ```\n- Read timeout from config in `_execute_cli()` using `load_config()[\"timeouts\"].get(eval_type, 45)` with `.get()` fallback for backward compat\n- Add to `_subprocess_env()`: `DISABLE_TELEMETRY=1`, `DISABLE_ERROR_REPORTING=1`\n- Do NOT add undocumented env vars (`CLAUDE_CODE_DISABLE_BACKGROUND_TASKS`, `CLAUDE_CODE_EXIT_AFTER_STOP_DELAY`) \u2014 these are unverified and may break\n\n## Key context\n\n- `subprocess.run` timeout calls `os.kill(pid, SIGKILL)` \u2014 does NOT call `os.killpg()` even with `process_group=0`. You MUST switch to `Popen` to get proper process group cleanup.\n- `Popen.communicate(timeout=N)` uses internal threads for pipe reading \u2014 safe to call `os.killpg()` after `TimeoutExpired` because the threads will receive broken-pipe and terminate.\n- The `_execute_cli` function has 3 prompt transport modes (stdin L586-601, file_stdin L603-620, arg L622-645). All 3 paths need the `Popen` refactor.\n- `_execute_cli` must accept an `eval_type` parameter (or the timeout value directly) to select the right timeout from config.\n- The `ConsecutiveFailureTracker` fingerprints exceptions by `str(exc)`. With variable timeout values, use a stable message like \"CLI timed out\" (not \"CLI timed out after 45s\") so the tracker still recognizes consecutive identical failures.\n## Acceptance\n- [ ] `_execute_cli()` uses `Popen` with `process_group=0`, not `subprocess.run`\n- [ ] Timeout triggers `os.killpg(proc.pid, signal.SIGTERM)` \u2192 grace \u2192 `os.killpg(proc.pid, signal.SIGKILL)`\n- [ ] `config.yaml` has a `timeouts` section with per-eval-type values\n- [ ] Timeout values are read from config (not hardcoded) with backward-compat `.get()` defaults\n- [ ] `--max-turns 1` added to CLI args (or documented as skipped if flag does not exist)\n- [ ] `_subprocess_env()` sets `DISABLE_TELEMETRY=1` and `DISABLE_ERROR_REPORTING=1`\n- [ ] No orphaned node/claude processes after a timed-out case (verify with `pgrep -f claude` before/after)\n- [ ] `python3 tests/evals/run_activation.py --limit 3` completes without hanging\n- [ ] Temp files from file_stdin mode cleaned up even after process group kill\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-25T06:48:04.021188Z",
        "depends_on": [
          "fn-62-fix-eval-subprocess-timeouts-and.1"
        ],
        "epic": "fn-62-fix-eval-subprocess-timeouts-and",
        "id": "fn-62-fix-eval-subprocess-timeouts-and.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-62-fix-eval-subprocess-timeouts-and.2.md",
        "status": "todo",
        "title": "Add per-runner wall-clock timeout to run_suite.sh with macOS shim",
        "updated_at": "2026-02-25T06:48:46.578427Z"
      },
      "id": "fn-62-fix-eval-subprocess-timeouts-and.2",
      "runtime": null,
      "spec": "# fn-62-fix-eval-subprocess-timeouts-and.2 Add per-runner wall-clock timeout to run_suite.sh with macOS shim\n\n## Description\nAdd a per-runner wall-clock timeout to `run_suite.sh` so that if the Python runner itself hangs (e.g., deadlocked pipe, uncaught exception in a loop), the suite still progresses. Add a macOS-compatible `timeout` shim since macOS does not ship GNU coreutils.\n\n**Size:** S\n**Files:** `tests/evals/run_suite.sh`\n\n## Approach\n\n- Add a `_timeout_cmd()` helper function that returns `timeout` on Linux, `gtimeout` if available on macOS, or a Perl shim (`perl -e \"alarm $dur; exec @ARGV\"`) as fallback\n- Wrap each `python3 run_*.py` invocation in `run_runner()` (L150-194) with the timeout command\n- Per-runner timeout values: activation=300s, confusion=300s, effectiveness=600s, size_impact=600s (these are outer bounds; per-case timeouts from task .1 are the primary defense)\n- Use `--signal=TERM --kill-after=10s` flags (send SIGTERM first, escalate to SIGKILL after 10s)\n- Check exit code 124 (GNU timeout's \"timed out\" signal) and treat as permanent failure for fail-fast\n- Add a trap handler to clean up any orphaned `claude`/`node` processes on suite exit: `trap 'pkill -f \"claude.*--print\" 2>/dev/null; pkill -f \"timeout.*claude\" 2>/dev/null' EXIT`\n\n## Key context\n\n- The `run_runner()` function at L150-194 captures stdout to extract `TOTAL_CALLS=`, `COST_USD=`, etc. The timeout wrapper must preserve stdout capture \u2014 wrap the `python3` command, not the entire function.\n- macOS `gtimeout` is installed via `brew install coreutils`. The Perl shim (`perl -e \"alarm $dur; exec @ARGV\"`) works without any package but does not support `--kill-after` (Perl alarm sends SIGALRM only). For the Perl path, use a simpler approach: just the alarm, no escalation to SIGKILL.\n- `run_suite.sh` already has `SUITE_SKIP_REMAINING` logic for fail-fast (L115-129). A runner timeout should set this flag.\n## Acceptance\n- [ ] Each runner invocation in `run_suite.sh` wrapped with a wall-clock timeout\n- [ ] macOS works without GNU coreutils (Perl shim fallback)\n- [ ] Exit code 124 from timeout triggers fail-fast (`SUITE_SKIP_REMAINING=1`)\n- [ ] Trap handler on EXIT cleans up orphaned claude/node processes\n- [ ] `./tests/evals/run_suite.sh --runs 1 --limit 3` completes within bounded time\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
