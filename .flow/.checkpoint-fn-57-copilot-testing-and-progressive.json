{
  "created_at": "2026-02-21T07:21:44.542874Z",
  "epic": {
    "data": {
      "branch_name": "fn-57-copilot-testing-and-progressive",
      "completion_review_status": "unknown",
      "completion_reviewed_at": null,
      "created_at": "2026-02-21T00:03:17.256428Z",
      "default_impl": null,
      "default_review": null,
      "default_sync": null,
      "depends_on_epics": [
        "fn-56-copilot-structural-compatibility"
      ],
      "id": "fn-57-copilot-testing-and-progressive",
      "next_task": 1,
      "plan_review_status": "ship",
      "plan_reviewed_at": "2026-02-21T01:11:56.413284Z",
      "spec_path": ".flow/specs/fn-57-copilot-testing-and-progressive.md",
      "status": "open",
      "title": "Copilot Testing and Progressive Disclosure",
      "updated_at": "2026-02-21T01:11:56.413526Z"
    },
    "spec": "# Copilot Testing and Progressive Disclosure\n\n## Overview\n\nProve that Copilot actually loads and uses dotnet-artisan skills after the structural changes in fn-56, catch regressions in Claude Code and Codex, optimize oversized skills for multi-platform delivery via progressive disclosure, and harden CI to gate on Copilot success.\n\n**Problem:** The plugin currently has no automated proof that Copilot discovers, loads, or correctly uses any skills. The CI workflow has `continue-on-error: true` for Copilot, silently swallowing failures. Additionally, 11+ skills exceed 500 lines and may confuse models or hit platform size limits (per dotnet-skills-evals data: truncation improved results for oversized skills).\n\n## Scope\n\n- Copilot activation smoke tests using dotnet-skills-evals patterns\n- Cross-provider regression tests (Claude Code, Codex, Copilot)\n- Progressive disclosure refactoring for all skills >500 lines (issue #48)\n- CI hardening: Copilot gate, version pinning, auth handling, frontmatter safety checks\n\n## Out of scope\n\n- Structural directory changes (covered by fn-56)\n- Frontmatter migration (covered by fn-56)\n- New skill content authoring\n\n## Approach\n\n1. **Smoke tests** modeled on dotnet-skills-evals activation eval pattern: test cases with expected_skills, verified against Copilot CLI output\n2. **Regression tests** verify existing Claude Code and Codex behavior unchanged after flatten\n3. **Progressive disclosure** following the Agent Skills spec: SKILL.md core <500 lines with sibling reference files (referenced via normal file paths, NOT `[skill:]` syntax)\n4. **CI hardening** incremental: first verify Copilot passes, then remove `continue-on-error`, with proper auth/infra-error handling\n\n## Risks\n\n- **Copilot CLI not available in CI runners** \u2192 version-pinned install step with auth handling and infra_error policy\n- **32-skill limit masks real failures** \u2192 smoke tests must target both visible and advisor-routed skills\n- **Progressive disclosure changes skill behavior** \u2192 before/after effectiveness comparison using eval patterns\n- **Eval framework external dependency** \u2192 pin dotnet-skills-evals version or vendor test patterns\n- **Forks can't run Copilot tests** \u2192 graceful skip with annotation for fork PRs\n\n## Quick commands\n\n```bash\n# Run Copilot smoke tests\npython tests/copilot-smoke/run_smoke.py --provider copilot\n\n# Run cross-provider regression\n./test.sh --agents claude,codex,copilot\n\n# Check skill sizes\nfind skills -name SKILL.md -exec wc -l {} + | sort -rn | head -20\n\n# Verify no skill exceeds 500 lines\nfind skills -name SKILL.md -exec sh -c 'lines=$(wc -l < \"$1\"); [ \"$lines\" -gt 500 ] && echo \"OVER: $1 ($lines lines)\"' _ {} \\;\n```\n\n## Acceptance\n\n- [ ] Copilot smoke tests exist and pass: verify skill discovery, activation, and content loading\n- [ ] Claude Code regression tests pass: all existing test cases unchanged\n- [ ] Codex regression tests pass: skill sync works with flat layout\n- [ ] All 11+ oversized skills refactored to <500 lines with sibling reference files\n- [ ] Sibling files referenced via normal file paths, not `[skill:]` syntax\n- [ ] CI workflow gates on Copilot success (continue-on-error removed)\n- [ ] Copilot CLI version pinned in CI workflow with auth handling\n- [ ] Infra errors vs test failures distinguished in CI\n- [ ] Frontmatter safety checks in CI (no BOM, no quoted descriptions, license present)\n- [ ] Fork CI behavior documented and graceful\n\n## Dependencies\n\n- Depends on fn-56 (structural compatibility) completing first\n- Uses patterns from dotnet-skills-evals (https://github.com/Aaronontheweb/dotnet-skills-evals)\n- References dotnet-skills issue #48 for progressive disclosure requirements\n\n## References\n\n- dotnet-skills-evals: https://github.com/Aaronontheweb/dotnet-skills-evals\n- Issue #48: https://github.com/Aaronontheweb/dotnet-skills/issues/48\n- Copilot CLI issues: #1464 (32-skill limit), #978 (skills not auto-activated)\n- Agent Skills spec progressive disclosure: https://agentskills.io/specification\n- Existing CI: .github/workflows/agent-live-routing.yml, .github/workflows/validate.yml\n"
  },
  "epic_id": "fn-57-copilot-testing-and-progressive",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-21T00:04:35.429307Z",
        "depends_on": [],
        "epic": "fn-57-copilot-testing-and-progressive",
        "id": "fn-57-copilot-testing-and-progressive.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-57-copilot-testing-and-progressive.1.md",
        "status": "todo",
        "title": "Copilot activation smoke tests",
        "updated_at": "2026-02-21T01:09:03.906767Z"
      },
      "id": "fn-57-copilot-testing-and-progressive.1",
      "runtime": {
        "assignee": "claire@novotny.org",
        "claim_note": "",
        "claimed_at": "2026-02-21T04:13:09.282350Z",
        "evidence": {
          "commits": [
            "0e4b608",
            "bedc15e"
          ],
          "prs": [],
          "tests": [
            "python3 tests/copilot-smoke/run_smoke.py --category negative",
            "./scripts/validate-skills.sh",
            "./scripts/validate-marketplace.sh"
          ]
        },
        "status": "done",
        "updated_at": "2026-02-21T04:37:42.149400Z"
      },
      "spec": "# fn-57-copilot-testing-and-progressive.1 Copilot activation smoke tests\n\n## Description\n\nCreate Copilot-specific activation smoke tests that prove skills are discovered, loaded, and correctly used by Copilot CLI. Model test patterns after the dotnet-skills-evals activation eval framework. Include tests for progressive disclosure (sibling file access).\n\n**Size:** M\n**Files:** tests/copilot-smoke/ (new directory), tests/copilot-smoke/cases.jsonl (test cases), tests/copilot-smoke/run_smoke.py (runner), tests/copilot-smoke/baseline.json (expected outcomes), tests/copilot-smoke/fixture-plugin/ (test-only fixture with sentinel sibling file)\n\n## Approach\n\n1. **Study dotnet-skills-evals activation eval** at `src/dotnet_skills_evals/eval_activation/`. The framework tests three discovery mechanisms: `tool` (function calling), `compressed` (terse index), `fat` (full descriptions). Our smoke tests should mirror the `tool` mechanism since that matches how Copilot discovers skills.\n\n2. **Create test case dataset** in JSONL format matching dotnet-skills-evals schema:\n   ```\n   {\"id\": \"smoke-001\", \"user_prompt\": \"...\", \"expected_skills\": [\"skill-name\"], \"should_activate\": true, \"category\": \"...\"}\n   ```\n   Cover:\n   - **Top visible skills**: Direct activation via prompt matching description\n   - **Advisor-routed skills**: Prompts that should trigger `dotnet-advisor` which then routes to skills outside the visible set\n   - **Negative controls**: Prompts that should NOT trigger any .NET skills\n   - **Progressive disclosure**: Verify Copilot can access sibling files (e.g., `reference.md`, `examples.md`) after activating a skill that references them\n   - Minimum 25 test cases (10 direct, 5 advisor-routed, 5 negative, 5 progressive disclosure)\n\n3. **Build smoke runner** that:\n   - Invokes Copilot CLI with each test prompt\n   - Parses output for evidence of skill loading (regex: `Base directory for this skill:\\s*(?<path>.+)`)\n   - Compares activated skills against expected_skills\n   - Produces a `results.json` with per-case pass/fail outcomes\n\n4. **Create a baseline file** (`baseline.json`) capturing the expected outcome for each test case deterministically:\n   ```json\n   {\"smoke-001\": {\"expected\": \"pass\", \"skills\": [\"dotnet-csharp-async-patterns\"]}, ...}\n   ```\n   Gate on \"no unexpected regressions vs baseline\" rather than percentage thresholds. When a test case is known-flaky or model-sensitive, mark it as `\"flaky\": true` in the baseline so CI doesn't fail on it, but still tracks the result.\n\n5. **Integrate with existing test harness**. The `copilot-refactor` branch already has `run-agent-routing-smoke.py` and `compare-agent-routing-baseline.py` \u2014 extend rather than replace.\n\n6. **Test advisor meta-routing specifically**: Verify that when the advisor is activated, skills referenced in its compressed catalog can be subsequently loaded on demand.\n\n7. **Test sibling file access** with deterministic evidence using a test-only fixture:\n   - Create a test fixture plugin under `tests/copilot-smoke/fixture-plugin/` with a minimal skill that has a sibling reference file containing a unique sentinel string (e.g., `SENTINEL-COPILOT-SIBLING-TEST-7f3a`). The sentinel must NOT appear in the core SKILL.md or any other loaded content.\n   - The smoke runner installs this fixture plugin in Copilot before running the sentinel test case (same pattern as `test.sh:prepare_copilot_plugin()`).\n   - Create a test prompt that asks for the sentinel string's context. Assert the response contains the sentinel.\n   - This keeps production skills untouched and avoids ordering dependencies with fn-57.3.\n\n## Key context\n\n- dotnet-skills-evals `loader.py` scans one level deep only \u2014 matches our flat layout\n- Existing `tests/agent-routing/cases.json` has routing test cases \u2014 Copilot smoke tests are complementary but distinct\n- Copilot CLI evidence pattern: `Base directory for this skill:\\s*(?<path>.+)` (from `docs/agent-routing-tests.md:L111`)\n- Copilot issue #978: \"Skills not auto-activated\" \u2014 descriptions must use strong activation language\n\n## Acceptance\n- [x] Test case dataset exists with >= 25 cases (10 direct, 5 advisor-routed, 5 negative, 5 progressive disclosure)\n- [x] Smoke runner can invoke Copilot CLI and parse skill activation evidence\n- [x] Baseline file captures expected per-case outcomes deterministically\n- [x] Regression comparison gates on \"no unexpected regressions vs baseline\" (not percentage thresholds)\n- [x] Known-flaky cases marked in baseline; CI does not fail on them but tracks results\n- [x] Negative controls: false activations tracked in baseline (informational, not a gate \u2014 occasional false positives are expected)\n- [x] Progressive disclosure: sibling file access verified via sentinel string (unique token in sibling file, asserted in response)\n- [x] Results output in a format compatible with `compare-agent-routing-baseline.py`\n- [x] Runner supports two modes: (1) default \u2014 skip with `infra_error` status and warning if Copilot not installed (exit 0); (2) `--require-copilot` \u2014 output `infra_error` and exit non-zero if Copilot unavailable (used by CI to enforce the gate on non-fork PRs)\n\n## Evidence\n- Commits: 0e4b608, bedc15e\n- Tests: python3 tests/copilot-smoke/run_smoke.py --category negative, ./scripts/validate-skills.sh, ./scripts/validate-marketplace.sh\n- PRs:\n## Done summary\nAdded Copilot activation smoke test framework with 29 test cases (13 direct, 5 advisor-routed, 5 negative, 6 progressive disclosure), Python runner that invokes Copilot CLI and parses skill activation evidence, baseline.json for deterministic regression gating, and sentinel fixture plugin for sibling file access verification."
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-21T00:04:35.546989Z",
        "depends_on": [],
        "epic": "fn-57-copilot-testing-and-progressive",
        "id": "fn-57-copilot-testing-and-progressive.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-57-copilot-testing-and-progressive.2.md",
        "status": "todo",
        "title": "Cross-provider regression tests",
        "updated_at": "2026-02-21T00:06:53.216294Z"
      },
      "id": "fn-57-copilot-testing-and-progressive.2",
      "runtime": {
        "assignee": "claire@novotny.org",
        "claim_note": "",
        "claimed_at": "2026-02-21T05:05:42.657503Z",
        "evidence": {
          "commits": [
            "b9679dccb262d688bdf4bddc2e004cb58dcfd2cd",
            "5fede19",
            "5b3c2c8"
          ],
          "prs": [],
          "tests": [
            "./scripts/validate-skills.sh",
            "./scripts/validate-marketplace.sh",
            "python3 scripts/run-agent-routing-smoke.py"
          ]
        },
        "status": "done",
        "updated_at": "2026-02-21T05:38:04.156562Z"
      },
      "spec": "# fn-57-copilot-testing-and-progressive.2 Cross-provider regression tests\n\n## Description\n\nVerify that Claude Code, Codex, and Copilot all correctly discover and use skills after the structural changes in fn-56. Catch regressions by comparing against pre-flatten baselines from the `main` branch.\n\n**Size:** M\n**Files:** tests/agent-routing/ (existing), test.sh, tests/agent-routing/provider-baseline.json, .github/workflows/agent-live-routing.yml\n\n## Approach\n\n1. **Use `main` branch as pre-flatten baseline**: The `agent-live-routing.yml` workflow already uses `baseline_ref` (default `main`) as the comparison point. No manual \"capture before starting\" step needed \u2014 `main` represents the pre-flatten state.\n\n2. **Post-flatten verification for Claude Code**:\n   - Run `./test.sh --agents claude` \u2014 verify all existing test cases pass\n   - Key check: `plugin.json` paths resolve correctly from Claude Code's plugin loader\n   - Key check: `[skill:name]` cross-references still resolve (validator already checks this)\n   - Key check: hooks still find scripts via `${CLAUDE_PLUGIN_ROOT}` (path-independent, should be fine)\n\n3. **Post-flatten verification for Codex**:\n   - Run `./test.sh --agents codex` \u2014 verify skill sync works\n   - Key check: `test.sh` find depth fix from fn-56.1 actually works (finds 131 skill dirs)\n   - Key check: `.agents/openai.yaml` path pattern updated\n\n4. **Post-flatten verification for Copilot**:\n   - Run `./test.sh --agents copilot`\n   - Key check: Copilot can discover skills from flat layout\n   - Key check: Evidence pattern `Base directory for this skill:` appears in output\n\n5. **Compare against `main` baseline**: Use the workflow's built-in baseline comparison mechanism to diff pre/post results. Flag any regressions.\n\n6. **Update `provider-baseline.json`** with new expected pass/fail per provider per test case if behavior intentionally changes. Include justification comments for any changes.\n\n## Key context\n\n- `test.sh` already handles per-provider setup: `prepare_claude_plugin()`, `prepare_codex_plugin()`, `prepare_copilot_plugin()` (L89-108)\n- `provider-baseline.json` defines expected pass/fail per provider per test case\n- The `copilot-refactor` branch already has `run-agent-routing-smoke.py` and `compare-agent-routing-baseline.py`\n- CI `agent-live-routing.yml` uses `baseline_ref` parameter pointing to `main` by default\n\n## Acceptance\n- [ ] `main` branch used as pre-flatten baseline (no manual capture step needed)\n- [ ] Claude Code: all existing test cases pass on flat layout\n- [ ] Codex: skill sync discovers 131 skills from flat layout\n- [ ] Copilot: discovers skills from flat layout\n- [ ] Baseline comparison shows no unintentional regressions vs `main`\n- [ ] `provider-baseline.json` updated with any intentional behavior changes + justification comments\n- [ ] All three providers can be tested via `./test.sh --agents claude,codex,copilot`\n\n## Evidence\n- Commits: b9679dccb262d688bdf4bddc2e004cb58dcfd2cd, 5fede19, 5b3c2c8\n- Tests: ./scripts/validate-skills.sh, ./scripts/validate-marketplace.sh, python3 scripts/run-agent-routing-smoke.py\n- PRs:\n## Done summary\nAdded cross-provider regression test scripts (run-agent-routing-smoke.py for structural verification and compare-agent-routing-baseline.py for baseline comparison) and refactored the CI workflow to use these Python scripts with a new structural-smoke gate job, robust baseline-ref handling, and proper missing-data/duplicate detection."
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-21T00:04:35.668788Z",
        "depends_on": [],
        "epic": "fn-57-copilot-testing-and-progressive",
        "id": "fn-57-copilot-testing-and-progressive.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-57-copilot-testing-and-progressive.3.md",
        "status": "todo",
        "title": "Progressive disclosure for oversized skills",
        "updated_at": "2026-02-21T00:21:15.009231Z"
      },
      "id": "fn-57-copilot-testing-and-progressive.3",
      "runtime": {
        "assignee": "claire@novotny.org",
        "claim_note": "",
        "claimed_at": "2026-02-21T06:06:01.234612Z",
        "evidence": {
          "commits": [
            "2cf0d19f0b80d9ba56dd9bedec452440ca9446ed"
          ],
          "prs": [],
          "tests": [
            "./scripts/validate-skills.sh",
            "line count check: all 11 skills under 500 lines"
          ]
        },
        "status": "done",
        "updated_at": "2026-02-21T06:28:25.125832Z"
      },
      "spec": "# fn-57-copilot-testing-and-progressive.3 Progressive disclosure for oversized skills\n\n## Description\n\nRefactor all oversized skills (>500 lines) into progressive disclosure format: core SKILL.md (<500 lines) plus sibling reference files. Per dotnet-skills-evals data, truncation actually improved results for oversized skills \u2014 extra content was \"actively confusing\" the model.\n\n**Size:** M (repetitive pattern across 11+ skills)\n**Files:** skills/dotnet-mermaid-diagrams/, skills/dotnet-grpc/, skills/dotnet-roslyn-analyzers/, skills/dotnet-terminal-gui/, skills/dotnet-observability/, skills/dotnet-system-commandline/, skills/dotnet-xml-docs/, skills/dotnet-ado-patterns/, skills/dotnet-maui-development/, skills/dotnet-architecture-patterns/, skills/dotnet-msbuild-tasks/ (and any others >500 lines)\n\n## Approach\n\nFor each oversized skill:\n\n1. **Identify content tiers**:\n   - **Core** (SKILL.md): Problem space, key patterns, routing rules, scope/OOS, essential gotchas \u2014 must stay under 500 lines\n   - **Examples** (examples.md): Detailed code examples, before/after patterns\n   - **Reference** (reference.md): API reference, configuration options, complete parameter lists\n   - **Common mistakes** (common-mistakes.md): Anti-patterns, debugging tips, migration gotchas\n\n2. **Extract to sibling files**: Move detailed content from SKILL.md into appropriate sibling files. Use **normal file references** (NOT `[skill:]` syntax \u2014 that is ONLY for referencing other skills/agents by ID). Example:\n   ```markdown\n   For detailed examples, see `examples.md` in this skill directory.\n   For API reference, see `reference.md`.\n   ```\n   How platforms access sibling files:\n   - Claude Code: Read tool loads sibling files on demand\n   - Copilot: Model can request files via tool when SKILL.md body references them\n\n3. **Preserve `[skill:]` cross-references**: Any `[skill:]` cross-references to OTHER SKILLS in extracted content must be preserved in the sibling files. `[skill:]` is ONLY for referencing other skills/agents by their ID.\n\n4. **Verify line counts**: Each refactored SKILL.md must be under 500 lines.\n\n**Priority order** (by size, most oversized first):\n1. dotnet-mermaid-diagrams (874 lines)\n2. dotnet-grpc (856 lines)\n3. dotnet-roslyn-analyzers (770 lines)\n4. dotnet-terminal-gui (754 lines)\n5. dotnet-observability (739 lines)\n6. dotnet-system-commandline (731 lines)\n7. dotnet-xml-docs (687 lines)\n8. dotnet-ado-patterns (682 lines)\n9. dotnet-maui-development (674 lines)\n10. dotnet-architecture-patterns (672 lines)\n11. dotnet-msbuild-tasks (665 lines)\n\n## Key context\n\n- Agent Skills spec recommends SKILL.md under 500 lines with sibling files for overflow\n- dotnet-skills-evals data: For akka-net-management (685 lines), truncation to 500 lines IMPROVED results\n- The `dotnet-windbg-debugging` skill already uses a `reference/` directory with 16 files \u2014 this is the existing pattern\n- Two skills already use `details.md` companion files (`dotnet-csharp-code-smells`, `dotnet-roslyn-analyzers`)\n- Sibling file access in Copilot is verified by fn-57.1 smoke tests (progressive disclosure test cases)\n\n## Acceptance\n- [ ] All 11 identified skills have SKILL.md under 500 lines\n- [ ] Each refactored skill has at least one sibling file (examples.md, reference.md, or common-mistakes.md)\n- [ ] No content is lost \u2014 all extracted content exists in sibling files\n- [ ] Core SKILL.md files retain routing essentials: scope, OOS, key patterns, cross-references to other skills\n- [ ] Sibling files referenced via normal file paths (e.g., \"See `examples.md`\"), NOT via `[skill:]` syntax\n- [ ] `[skill:]` cross-references to OTHER SKILLS preserved in both core and sibling files\n- [ ] `./scripts/validate-skills.sh` passes after changes\n- [ ] `find skills -name SKILL.md -exec sh -c 'lines=$(wc -l < \"$1\"); [ \"$lines\" -gt 500 ] && echo \"$1: $lines\"' _ {} \\;` returns zero matches\n- [ ] Sibling file naming follows existing convention (reference/, examples.md, details.md)\n\n## Done summary\nRefactored 11 oversized SKILL.md files (>500 lines) into progressive disclosure format: extracted detailed code examples to sibling examples.md files while retaining routing essentials (scope, OOS, cross-references, agent gotchas) in core SKILL.md files, all now under 500 lines. Validation passes (131 skills, PASSED).\n## Evidence\n- Commits: 2cf0d19f0b80d9ba56dd9bedec452440ca9446ed\n- Tests: ./scripts/validate-skills.sh, line count check: all 11 skills under 500 lines\n- PRs:"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-21T00:04:35.788124Z",
        "depends_on": [
          "fn-57-copilot-testing-and-progressive.1",
          "fn-57-copilot-testing-and-progressive.2"
        ],
        "epic": "fn-57-copilot-testing-and-progressive",
        "id": "fn-57-copilot-testing-and-progressive.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-57-copilot-testing-and-progressive.4.md",
        "status": "todo",
        "title": "CI hardening for Copilot gate",
        "updated_at": "2026-02-21T01:12:13.956450Z"
      },
      "id": "fn-57-copilot-testing-and-progressive.4",
      "runtime": {
        "assignee": "claire@novotny.org",
        "claim_note": "",
        "claimed_at": "2026-02-21T06:39:31.219921Z",
        "evidence": {
          "commits": [
            "1dbb77f",
            "2a54309",
            "3d01f93"
          ],
          "prs": [],
          "tests": [
            "./scripts/validate-skills.sh",
            "./scripts/validate-marketplace.sh"
          ]
        },
        "status": "done",
        "updated_at": "2026-02-21T07:10:26.493474Z"
      },
      "spec": "# fn-57-copilot-testing-and-progressive.4 CI hardening for Copilot gate\n\n## Description\n\nHarden CI to make Copilot a functional gate on PRs, pin Copilot CLI version, add frontmatter safety checks, and handle auth/availability gracefully. Use a \"soft infra, hard functional\" policy with deterministic rules for when infra_error is acceptable.\n\n**Size:** M\n**Files:** .github/workflows/validate.yml, .github/workflows/agent-live-routing.yml, docs/agent-routing-tests.md\n\n## Approach\n\n1. **Add Copilot smoke subset to `validate.yml` (Option A)**: The current `agent-live-routing.yml` only runs on `workflow_dispatch` and `schedule`, so it cannot block PRs. Add a new job `copilot-smoke` to `validate.yml` (which runs on `pull_request`) that runs a lightweight Copilot smoke subset:\n   - **Job name**: `copilot-smoke`\n   - **What it runs**: A subset of the smoke cases from fn-57.1 (5-10 deterministic, non-flaky cases covering direct activation, advisor routing, and one negative control). The gated subset must exclude any case marked `\"flaky\": true` in the baseline.\n   - **Output format**: `results.json` matching the baseline comparison format from fn-57.1\n   - **Gate behavior**: Compare results against the committed baseline; fail on unexpected regressions\n   - Keep `agent-live-routing.yml` for comprehensive scheduled/manual testing with full 25+ cases across all providers.\n\n2. **Copilot CLI install and auth in CI** \u2014 two-phase approach:\n   - **Phase 1 (first step of T4)**: Create a throwaway GitHub Actions workflow (`copilot-install-proof.yml`) that proves `copilot` binary install + `copilot plugin marketplace add` + `copilot plugin marketplace list` all work on `ubuntu-latest`. Record the exact install command, binary path, and auth env vars that work. This proof gates the rest of T4.\n   - **Phase 2 (after proof)**: Add the proven install steps to `validate.yml`:\n     - **Auth**: Use `env: { GITHUB_TOKEN: ${{ github.token }} }` (the built-in Actions token). If that's insufficient for Copilot auth, use a dedicated `${{ secrets.COPILOT_TOKEN }}` secret instead.\n     - **Availability check**: `copilot auth status` (or `copilot --version`) must exit 0. If it fails \u2192 `infra_error`.\n     - **Plugin registration** (from `test.sh:prepare_copilot_plugin()`):\n       ```\n       copilot plugin marketplace add \"$REPO_ROOT\"\n       copilot plugin install dotnet-artisan@dotnet-artisan\n       ```\n     - **Discovery verification**: `copilot plugin marketplace list | grep -F \"dotnet-artisan\"`\n     - **Permissions**: If install-proof requires broader permissions than `contents: read`, update `validate.yml` workflow `permissions:` to the minimal set that makes auth succeed, and document the change.\n\n3. **\"Soft infra, hard functional\" gating in `validate.yml`** (fork/no-secrets rule for `copilot-smoke` job):\n   - If `github.event.pull_request.head.repo.fork == true` OR `copilot auth status` exits non-zero \u2192 produce synthetic `results.json` with `status: \"infra_error\"`, exit 0 with annotation \"Copilot skipped (fork/no auth)\"\n   - Otherwise \u2192 `infra_error` is a failure (Copilot should be available on non-fork PRs)\n   - The smoke runner must support a `--require-copilot` flag (or env var `REQUIRE_COPILOT=true`): when set, outputs `infra_error` AND exits non-zero if Copilot is unavailable. The `validate.yml` job sets this flag on non-fork PRs so infra_error is never silently swallowed.\n\n4. **Simplify `agent-live-routing.yml` Copilot handling**:\n   - Remove `continue-on-error: ${{ matrix.agent == 'copilot' }}` from the Copilot matrix job\n   - **Schedule runs**: Hard-code `fail_on_infra=true` behavior (schedule has no inputs). If Copilot infra is down during a scheduled run, it should fail to surface the issue.\n   - **Manual (`workflow_dispatch`) runs**: Keep existing `fail_on_infra` input (current default: `false`). Update default to `true` to match schedule behavior.\n   - Update `summarize` job to handle `infra_error` status: count as \"failed\" when `fail_on_infra=true` (schedule or explicit), \"skipped\" when `fail_on_infra=false` (manual override only)\n\n5. **Verify frontmatter safety checks run in CI**: The `validate.yml` workflow runs `./scripts/validate-skills.sh` which calls `_validate_skills.py`. Verify that the Copilot frontmatter checks added in fn-56.2 (BOM, quoted description, missing license, metadata ordering) are treated as ERRORs and thus fail the validation workflow.\n\n6. **Add skill count assertion to CI**: `find skills -name SKILL.md -maxdepth 2 | wc -l` must equal 131. Add to `validate.yml`.\n\n7. **Add flat layout guard to CI**: Verify `_validate_skills.py`'s flat layout guard (from fn-56.3) runs in CI and ERRORs on nested skills.\n\n8. **Define exit criteria documentation**: Add a section to `docs/agent-routing-tests.md`:\n   - What \"Copilot passes\" means (evidence patterns, baseline comparison)\n   - Deterministic rules for when `infra_error` is acceptable: fork/no-secrets in PR CI, `fail_on_infra=false` manual override\n   - How to update baselines when intentional behavior changes\n   - Fork behavior documentation\n\n## Key context\n\n- Current CI: `agent-live-routing.yml` runs on `workflow_dispatch` + `schedule` ONLY (not on PRs!)\n- `validate.yml` runs on `push` and `pull_request` \u2014 this is where PR-blocking Copilot checks go\n- Copilot has been soft-failure since fn-54 (via `continue-on-error: ${{ matrix.agent == 'copilot' }}`)\n- The `summarize` job in `agent-live-routing.yml` hardcodes `PROVIDERS=(claude codex copilot)` \u2014 must handle missing/infra_error results\n- Forks can't access repo secrets \u2192 Copilot tests naturally skip on fork PRs\n- `test.sh` already has `prepare_copilot_plugin()` with the exact `copilot plugin marketplace add/install` flow\n- `agent-live-routing.yml` already has `fail_on_infra` workflow input (default: `false`); schedule runs currently have no equivalent\n\n## Acceptance\n- [x] `copilot-smoke` job added to `validate.yml` running a deterministic smoke subset on PRs\n- [x] Smoke job compares results against committed baseline (not percentage thresholds)\n- [x] Copilot CLI install proven on `ubuntu-latest` via throwaway workflow (exact install command + auth env documented)\n- [x] Copilot CLI pinned version in CI workflow\n- [x] Plugin registration uses same mechanism as `test.sh:prepare_copilot_plugin()`\n- [x] Auth mechanism implemented (token source documented, `copilot --version` health check gates execution)\n- [x] Smoke runner supports `--require-copilot` flag: non-fork PRs exit non-zero on infra_error\n- [x] `validate.yml`: fork/no-secrets \u2192 accept infra_error; non-fork with secrets \u2192 infra_error is failure (enforced via `--require-copilot`)\n- [x] `agent-live-routing.yml`: `continue-on-error` removed; schedule hard-codes `fail_on_infra=true`; `workflow_dispatch` default changed to `true`\n- [x] `summarize` job handles `infra_error` status: \"failed\" when `fail_on_infra=true`, \"skipped\" otherwise\n- [x] Frontmatter safety checks verified running in CI as ERRORs\n- [x] Flat layout guard verified running in CI\n- [x] Skill count assertion (131) added to CI\n- [x] Exit criteria documented in docs/agent-routing-tests.md with deterministic infra_error rules per workflow\n- [x] Fork CI behavior documented and tested\n\n## Evidence\n- Commits: 1dbb77f, 2a54309, 3d01f93\n- Tests: ./scripts/validate-skills.sh, ./scripts/validate-marketplace.sh\n- PRs:\n## Done summary\nHardened CI for Copilot gate: added copilot-smoke job to validate.yml with 8 deterministic smoke cases on PRs, implemented soft infra / hard functional policy (fork/no-secrets accepts infra_error, non-fork requires Copilot via --require-copilot), pinned Copilot CLI v0.0.412, added skill count assertion (131), removed continue-on-error from agent-live-routing.yml, updated fail_on_infra defaults to true for both schedule and manual runs, updated summarize job to enforce infra_error policy, documented exit criteria in docs/agent-routing-tests.md, and created copilot-install-proof.yml throwaway workflow."
    }
  ]
}
