{
  "created_at": "2026-02-14T09:25:25.524451Z",
  "epic": {
    "data": {
      "branch_name": "fn-23-hooks-and-mcp-integration",
      "created_at": "2026-02-11T22:23:33.169658Z",
      "depends_on_epics": [
        "fn-2-plugin-skeleton-and-infrastructure"
      ],
      "id": "fn-23-hooks-and-mcp-integration",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-23-hooks-and-mcp-integration.md",
      "status": "open",
      "title": "Hooks and MCP Integration",
      "updated_at": "2026-02-14T09:23:50.797229Z"
    },
    "spec": "# fn-23: Hooks and MCP Integration\n\n## Problem/Goal\nCreate hooks.json with file-type-specific matchers for smart defaults (format on .cs edit, restore on .csproj edit, test suggestion on test file edit, validate on .xaml edit), configure MCP servers (Context7 for library docs), and document hook behavior for plugin users.\n\n## Dependencies\n- **Hard**: fn-2 (Plugin Skeleton) \u2014 provides `hooks/hooks.json` and `.mcp.json` stubs, `plugin.json` references\n- **Soft**: fn-12 (Blazor Skills), fn-13 (Uno Platform Skills) \u2014 MCP servers enhance these skills with live docs\n\n## Scope\n\n**In scope:**\n- `hooks/hooks.json` with PostToolUse hooks for `.cs`, `.csproj`, `.xaml`, and test file matchers\n- `.mcp.json` configured for Context7 MCP (covers Microsoft Learn, NuGet, and general .NET ecosystem docs)\n- Hook scripts in `scripts/hooks/` directory (bash, invoked by hooks.json)\n- Documentation for configuring hook behavior (disable, troubleshoot)\n\n**Out of scope:**\n- Debounce/cancellation/per-solution serialization (these are Claude Code runtime features, not plugin-controllable; hooks run synchronously or async but the plugin cannot implement its own debounce logic within the hook system)\n- Stale-result suppression (same reason: not controllable at plugin level)\n- Plugin settings system (Claude Code plugins do not have a user-configurable settings mechanism; users control hooks via `disableAllHooks` or removing hook entries)\n- PreToolUse hooks for blocking (not appropriate for a best-practices plugin; too intrusive)\n\n## Hooks Architecture\n\n### Hook Event Selection\n\nThe plugin uses these hook events:\n\n| Event | Matcher | Purpose | Type | Async |\n|-------|---------|---------|------|-------|\n| `PostToolUse` | `Write\\|Edit` | Single script dispatches by file extension: `.cs` format, `.csproj` restore suggestion, `.xaml` validation, `*Tests.cs` test suggestion | `command` | `true` |\n| `SessionStart` | `startup` | Detect .NET SDK version and project type, inject context | `command` | `false` |\n\n**Note on PostToolUse consolidation:** A single hook entry with matcher `Write|Edit` routes to one script (`post-edit-dotnet.sh`) that dispatches internally by file extension. This avoids multiple hook entries with the same matcher and keeps dispatch logic in one place.\n\n**Note on SessionStart matcher:** Claude Code SessionStart events support matchers: `startup`, `resume`, `clear`, `compact`. Using `\"startup\"` ensures the context hook fires only on new sessions, not on resume/clear/compact (which already have context).\n\n### Hook Script Design\n\nAll hook scripts:\n- Live in `scripts/hooks/` directory (must be created by task 1)\n- Are referenced via `${CLAUDE_PLUGIN_ROOT}/scripts/hooks/<name>.sh`\n- Read JSON from stdin, extract relevant fields with `jq`\n- Use file extension checks to filter (e.g., only act on `.cs` files)\n- Exit 0 for success (stdout shown in verbose mode)\n- Exit 0 with JSON `systemMessage` or `additionalContext` for feedback\n- Never exit 2 (plugin hooks should advise, not block)\n\n### Hook Output Format\n\nScripts output JSON to stdout on exit 0:\n\n```json\n// PostToolUse: feedback message to Claude\n{\"systemMessage\": \"dotnet format applied to Program.cs\"}\n\n// PostToolUse: tool missing warning\n{\"systemMessage\": \"dotnet not found in PATH -- skipping format. Install .NET SDK to enable auto-formatting.\"}\n\n// SessionStart: context injection\n{\"additionalContext\": \"This is a .NET 9 project (net9.0) with 3 projects in solution.\"}\n```\n\n### File Extension Filtering\n\nSince Claude Code matchers filter on tool name (not file path), each hook script must extract `file_path` from `tool_input` and check the extension:\n\n```bash\nFILE_PATH=$(echo \"$INPUT\" | jq -r '.tool_input.file_path // empty')\ncase \"$FILE_PATH\" in\n  *Tests.cs|*Test.cs) # suggest running tests ;;\n  *.cs) # run dotnet format ;;\n  *.csproj) # suggest dotnet restore ;;\n  *.xaml) # check XML well-formedness ;;\n  *) exit 0 ;; # ignore other files\nesac\n```\n\n### Async vs Sync\n\n- `dotnet format` hook: `async: true` (runs in background, takes 5-30s, reports results on next turn)\n- `dotnet restore` suggestion: handled within async script (fast stdout)\n- XAML validation: handled within async script (fast XML check)\n- Test suggestion: handled within async script (fast stdout)\n- SessionStart context: sync (fast, reads files only)\n\n## MCP Server Architecture\n\n### Server Selection\n\n| Server | Transport | Purpose | Command |\n|--------|-----------|---------|---------|\n| Context7 | stdio | Library documentation lookup (covers Microsoft Learn, NuGet, .NET ecosystem) | `npx -y @upstash/context7-mcp@latest` |\n\n### Version Stability Note\n\nContext7 uses `@latest` for initial ship. After stabilization, evaluate pinning to a specific version (e.g., `@1.x.x`) to prevent upstream breaking changes. Document this as a follow-up item.\n\n### Environment Variable Expansion\n\n`.mcp.json` uses `${CLAUDE_PLUGIN_ROOT}` for plugin-relative paths where needed. API keys use `${VAR_NAME}` syntax for user-provided credentials.\n\n### Server Lifecycle\n\nPlugin MCP servers start automatically when plugin is enabled. Users must restart Claude Code after enabling/disabling plugin to apply MCP server changes.\n\n## Task Decomposition\n\n| Task | Deliverables | Files touched | Dependencies |\n|------|-------------|---------------|--------------|\n| fn-23.1 | `hooks/hooks.json`, hook scripts in `scripts/hooks/` | `hooks/hooks.json` (edit), `scripts/hooks/post-edit-dotnet.sh` (new), `scripts/hooks/session-start-context.sh` (new) | None |\n| fn-23.2 | `.mcp.json` with MCP server configs | `.mcp.json` (edit) | None |\n| fn-23.3 | Documentation, validation updates | `scripts/validate-marketplace.sh` (edit) | fn-23.1, fn-23.2 |\n\n## Risks\n\n| Risk | Impact | Mitigation |\n|------|--------|------------|\n| `dotnet format` not installed on user machine | Hook script fails silently | Script checks for `dotnet` command availability, exits 0 with warning if missing |\n| MCP servers require npx/node not available | MCP tools unavailable | Document Node.js requirement; servers degrade gracefully (Claude works without them) |\n| Hook scripts slow down editing workflow | User frustration | Use `async: true` for slow operations; fast checks stay sync |\n| XAML validation false positives | Noisy output | Only check XML well-formedness, not schema validation |\n| Context7 `@latest` upstream breakage | MCP tools stop working | Pin version after stabilization (follow-up) |\n\n## Acceptance Checks\n- [ ] `hooks/hooks.json` contains PostToolUse hook with `Write|Edit` matcher (single entry, internal dispatch)\n- [ ] `hooks/hooks.json` contains SessionStart hook with `startup` matcher\n- [ ] Hook scripts in `scripts/hooks/` are executable, read stdin JSON, filter by file extension\n- [ ] `post-edit-dotnet.sh` handles `.cs` (format), `.csproj` (restore), `.xaml` (validation), `*Tests.cs` (test suggestion)\n- [ ] `dotnet format` hook uses `async: true` and reports results via `systemMessage`\n- [ ] `.mcp.json` configured with Context7 MCP server\n- [ ] SessionStart hook detects .NET project type and returns `additionalContext`\n- [ ] All hook scripts handle missing tools gracefully (exit 0 with warning, never exit 2)\n- [ ] Hook output follows documented JSON format (`systemMessage` or `additionalContext`)\n- [ ] `validate-marketplace.sh` passes (exit 0) including new hook/MCP validation checks\n- [ ] Hook scripts use `${CLAUDE_PLUGIN_ROOT}` for portable paths\n- [ ] Task 3 depends on tasks 1 and 2\n\n## Key Context\n- Claude Code hooks.json plugin format requires `{\"hooks\": {...}}` wrapper (not bare events)\n- Optional `\"description\"` field at top level for plugin hooks\n- Matchers are regex on tool name, not file path -- file filtering must happen in script\n- SessionStart matchers filter on how session started: `startup`, `resume`, `clear`, `compact`\n- Plugin hooks merge with user/project hooks when plugin is enabled\n- Hooks snapshot at session start; mid-session edits require `/hooks` menu review\n- `${CLAUDE_PLUGIN_ROOT}` is available in hook command strings\n- Inline `mcpServers` in plugin.json has a known parsing bug -- use `.mcp.json` file reference\n"
  },
  "epic_id": "fn-23-hooks-and-mcp-integration",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-11T22:32:32.678235Z",
        "depends_on": [],
        "epic": "fn-23-hooks-and-mcp-integration",
        "id": "fn-23-hooks-and-mcp-integration.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-23-hooks-and-mcp-integration.1.md",
        "status": "todo",
        "title": "Create hooks.json with file-type-specific matchers",
        "updated_at": "2026-02-14T09:24:23.424173Z"
      },
      "id": "fn-23-hooks-and-mcp-integration.1",
      "runtime": null,
      "spec": "# fn-23-hooks-and-mcp-integration.1 Create hooks.json with file-type-specific matchers\n\n## Description\nPopulate `hooks/hooks.json` with PostToolUse and SessionStart hooks. Create `scripts/hooks/` directory and the corresponding bash scripts.\n\n### hooks.json Structure\n\n```json\n{\n  \"description\": \"dotnet-artisan: smart defaults for .NET development\",\n  \"hooks\": {\n    \"PostToolUse\": [\n      {\n        \"matcher\": \"Write|Edit\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"${CLAUDE_PLUGIN_ROOT}/scripts/hooks/post-edit-dotnet.sh\",\n            \"async\": true,\n            \"timeout\": 60\n          }\n        ]\n      }\n    ],\n    \"SessionStart\": [\n      {\n        \"matcher\": \"startup\",\n        \"hooks\": [\n          {\n            \"type\": \"command\",\n            \"command\": \"${CLAUDE_PLUGIN_ROOT}/scripts/hooks/session-start-context.sh\",\n            \"timeout\": 10\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n\n**SessionStart matcher note:** Claude Code SessionStart events support matchers: `startup`, `resume`, `clear`, `compact`. Using `\"startup\"` ensures context injection fires only on new sessions. This is documented behavior per Claude Code hooks reference.\n\n### Directory Setup\n\nCreate `scripts/hooks/` directory. Ensure both scripts are `chmod +x`.\n\n### Hook Scripts\n\n**`scripts/hooks/post-edit-dotnet.sh`** (async PostToolUse):\n1. Read JSON from stdin into `INPUT` variable\n2. Extract `tool_input.file_path` using `jq`\n3. Switch on file extension (order matters -- test files before general .cs):\n   - `*Tests.cs` / `*Test.cs`: Return suggestion to run related tests\n   - `*.cs`: Run `dotnet format <file>` if `dotnet` is available. Return results.\n   - `*.csproj`: Return suggestion to run `dotnet restore`.\n   - `*.xaml`: Run XML well-formedness check (`xmllint --noout` or python `xml.etree`). Return result.\n   - Other: `exit 0` silently.\n4. Never exit 2. If tools are missing, exit 0 with a warning.\n\n**`scripts/hooks/session-start-context.sh`** (sync SessionStart):\n1. Check if current directory contains `.sln`, `.csproj`, or `global.json`\n2. If found, extract TFM from first `.csproj`, output `additionalContext`\n3. If not a .NET project, exit 0 silently\n\n### Hook Output Format\n\nEach script outputs JSON to stdout on exit 0:\n\n```bash\n# PostToolUse: success message\necho '{\"systemMessage\": \"dotnet format applied to Program.cs\"}'\n\n# PostToolUse: tool missing\necho '{\"systemMessage\": \"dotnet not found in PATH -- skipping format. Install .NET SDK to enable auto-formatting.\"}'\n\n# PostToolUse: test suggestion\necho '{\"systemMessage\": \"Test file modified: UserServiceTests.cs. Consider running: dotnet test --filter UserServiceTests\"}'\n\n# PostToolUse: restore suggestion\necho '{\"systemMessage\": \"Project file modified. Consider running: dotnet restore\"}'\n\n# PostToolUse: XAML validation result\necho '{\"systemMessage\": \"XAML validation: MainWindow.xaml is well-formed\"}'\n\n# SessionStart: context injection\necho '{\"additionalContext\": \"This is a .NET 9 project (net9.0) with 3 projects in solution.\"}'\n```\n\n### Implementation Notes\n- Scripts must be `chmod +x`\n- Scripts use `jq` for JSON parsing (available on most systems; fallback to python if needed)\n- All paths use `${CLAUDE_PLUGIN_ROOT}` in hooks.json\n- The `post-edit-dotnet.sh` script is marked `async: true` because `dotnet format` can take 5-30 seconds\n- Test file patterns: match `*Tests.cs` and `*Test.cs` before `*.cs` in case statement\n\n## Acceptance\n- [ ] `scripts/hooks/` directory exists\n- [ ] `hooks/hooks.json` is valid JSON with `{\"description\": \"...\", \"hooks\": {...}}` wrapper\n- [ ] PostToolUse matcher is `Write|Edit` (regex matching both tools)\n- [ ] PostToolUse hook has `\"async\": true` and `\"timeout\": 60`\n- [ ] SessionStart matcher is `\"startup\"` (fires only on new sessions)\n- [ ] `post-edit-dotnet.sh` exists in `scripts/hooks/`, is executable (`chmod +x`)\n- [ ] `session-start-context.sh` exists in `scripts/hooks/`, is executable (`chmod +x`)\n- [ ] `post-edit-dotnet.sh` reads stdin JSON, extracts file_path, switches on extension\n- [ ] `.cs` handler runs `dotnet format` (or warns if unavailable), outputs `systemMessage` JSON\n- [ ] `*Tests.cs` / `*Test.cs` handler suggests running tests, outputs `systemMessage` JSON\n- [ ] `.csproj` handler suggests `dotnet restore`, outputs `systemMessage` JSON\n- [ ] `.xaml` handler checks XML well-formedness, outputs `systemMessage` JSON\n- [ ] `session-start-context.sh` detects .NET project type and outputs `additionalContext` JSON\n- [ ] No hook script ever exits with code 2\n- [ ] SessionStart hook actually fires when tested in a Claude Code session\n- [ ] `validate-marketplace.sh` passes (exit 0)\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-11T22:32:32.807787Z",
        "depends_on": [],
        "epic": "fn-23-hooks-and-mcp-integration",
        "id": "fn-23-hooks-and-mcp-integration.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-23-hooks-and-mcp-integration.2.md",
        "status": "todo",
        "title": "Configure MCP servers (.mcp.json)",
        "updated_at": "2026-02-14T09:24:44.550083Z"
      },
      "id": "fn-23-hooks-and-mcp-integration.2",
      "runtime": null,
      "spec": "# fn-23-hooks-and-mcp-integration.2 Configure MCP servers (.mcp.json)\n\n## Description\nPopulate `.mcp.json` with MCP server configurations for external documentation services that enhance the plugin's skills.\n\n### .mcp.json Structure\n\n```json\n{\n  \"mcpServers\": {\n    \"context7\": {\n      \"command\": \"npx\",\n      \"args\": [\"-y\", \"@upstash/context7-mcp@latest\"],\n      \"env\": {}\n    }\n  }\n}\n```\n\n### Server Selection Rationale\n\n**Context7** (primary):\n- Provides library documentation lookup for any .NET library\n- Covers Microsoft Learn docs, NuGet package docs, and general .NET ecosystem\n- Single server that handles broad documentation needs\n- No API key required, just npx\n\n**Uno Platform MCP and Microsoft Learn MCP** (deferred):\n- These are already accessible through Context7 and through deferred MCP tools configured in this project\n- Only add dedicated servers if they provide capabilities beyond Context7\n- Check Anthropic MCP registry for official server availability before adding\n\n### Version Stability\n\nThe initial config uses `@upstash/context7-mcp@latest` for convenience. **Follow-up item:** After initial ship and stabilization, evaluate pinning to a specific version (e.g., `@1.x.x`) to prevent upstream breaking changes from silently breaking the plugin. This tradeoff (ship now with @latest, pin later) should be documented in the task's done summary.\n\n### Implementation Notes\n- Use `${CLAUDE_PLUGIN_ROOT}` for any plugin-relative paths in server configs\n- Use `${VAR_NAME}` syntax for any user-provided API keys\n- Test that `npx -y @upstash/context7-mcp@latest` starts successfully before shipping\n\n### Validation\n- `.mcp.json` must be valid JSON\n- Must have top-level `mcpServers` key (even if empty)\n- Server command must be available (npx requires Node.js)\n\n## Acceptance\n- [ ] `.mcp.json` contains at least one MCP server configuration (Context7)\n- [ ] `.mcp.json` is valid JSON with `mcpServers` top-level key\n- [ ] Context7 server config uses `npx -y @upstash/context7-mcp@latest`\n- [ ] Any API-key-requiring servers use `${VAR_NAME}` env var expansion\n- [ ] `validate-marketplace.sh` passes (exit 0)\n- [ ] Server starts successfully when tested manually with `npx -y @upstash/context7-mcp@latest`\n- [ ] Done summary notes the @latest vs pinned version tradeoff\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-11T22:32:32.931349Z",
        "depends_on": [
          "fn-23-hooks-and-mcp-integration.1",
          "fn-23-hooks-and-mcp-integration.2"
        ],
        "epic": "fn-23-hooks-and-mcp-integration",
        "id": "fn-23-hooks-and-mcp-integration.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-23-hooks-and-mcp-integration.3.md",
        "status": "todo",
        "title": "Document hook/MCP behavior and validate",
        "updated_at": "2026-02-14T09:25:09.611950Z"
      },
      "id": "fn-23-hooks-and-mcp-integration.3",
      "runtime": null,
      "spec": "# fn-23-hooks-and-mcp-integration.3 Document hook/MCP behavior and validate\n\n## Description\nEnsure hooks and MCP integration are documented and validation scripts cover the new files. This task does NOT implement a plugin settings system (Claude Code plugins have no user-configurable settings mechanism), but documents how users can control behavior.\n\n**Dependencies:** This task depends on fn-23.1 and fn-23.2 (hooks and MCP must exist before validation can verify them).\n\n### Documentation Deliverables\n\nAdd a section to the plugin's documentation covering:\n\n1. **What hooks do**: Brief explanation of each hook behavior:\n   - `.cs` edits: auto-formats with `dotnet format` (async, reports on next turn)\n   - `.csproj` edits: suggests running `dotnet restore`\n   - `.xaml` edits: validates XML well-formedness\n   - `*Tests.cs` edits: suggests running related tests\n   - Session start: detects .NET project type and injects context\n2. **How to disable hooks**: Point users to `disableAllHooks: true` in `.claude/settings.json` or `/hooks` menu\n3. **MCP server requirements**: Node.js required for Context7 (`npx`); how to check with `/mcp`\n4. **Troubleshooting**: Common issues:\n   - `dotnet` not found: install .NET SDK, hook degrades gracefully\n   - `npx` not available: install Node.js, MCP servers won't start\n   - Hooks not firing: restart Claude Code (hooks snapshot at startup)\n   - `jq` not found: install jq or hook script falls back to python\n\n### Validation Additions to validate-marketplace.sh\n\nAdd after the existing mcpServers path check:\n\n```bash\n# --- hooks validation ---\n\n# 1. Validate hooks/hooks.json has a \"hooks\" key\nif ! jq -e '.hooks' hooks/hooks.json >/dev/null 2>&1; then\n  echo \"ERROR: hooks/hooks.json missing 'hooks' key\"\n  ERRORS=$((ERRORS + 1))\nfi\n\n# 2. Validate .mcp.json has \"mcpServers\" key\nif ! jq -e '.mcpServers' .mcp.json >/dev/null 2>&1; then\n  echo \"ERROR: .mcp.json missing 'mcpServers' key\"\n  ERRORS=$((ERRORS + 1))\nfi\n\n# 3. Check all scripts/hooks/*.sh are executable\nif ls scripts/hooks/*.sh 1>/dev/null 2>&1; then\n  for script in scripts/hooks/*.sh; do\n    if [ ! -x \"$script\" ]; then\n      echo \"ERROR: $script is not executable (chmod +x needed)\"\n      ERRORS=$((ERRORS + 1))\n    fi\n  done\nfi\n```\n\n### Implementation Notes\n- Documentation can be inline in a skill SKILL.md, in a hooks guide file, or prepared for fn-25 (README)\n- Validation should be lightweight and match existing script patterns (error counter, sequential checks)\n- Keep documentation concise; users can read Claude Code docs for hook system details\n\n## Acceptance\n- [ ] Documentation exists explaining what each hook does (format, restore, XAML, tests, session context)\n- [ ] Documentation explains how to disable hooks (`disableAllHooks` or `/hooks` menu)\n- [ ] Documentation explains MCP server requirements (Node.js for npx)\n- [ ] Documentation includes troubleshooting for common issues\n- [ ] `validate-marketplace.sh` validates `hooks/hooks.json` has `hooks` key (not just valid JSON)\n- [ ] `validate-marketplace.sh` validates `.mcp.json` has `mcpServers` key\n- [ ] `validate-marketplace.sh` checks `scripts/hooks/*.sh` for executable permission\n- [ ] All validation passes (exit 0)\n\n## Done summary\nTBD\n\n## Evidence\n- Commits:\n- Tests:\n- PRs:\n"
    }
  ]
}
